<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Request Analysis Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ----------------------------------------------------------- */
/*  VISIONOS GLOBAL STYLE ‚Äî BLUR + LIGHT + SHADOWS             */
/* ----------------------------------------------------------- */
:root {
  --glass: rgba(255,255,255,0.22);
  --glass-border: rgba(255,255,255,0.32);
  --glass-dark: rgba(255,255,255,0.15);
  --text: #0f0f0f;
  --primary: #0a84ff;
  --bg1: #fafdff;
  --bg2: #eef4ff;
  --radius: 22px;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  color: var(--text);
  padding: 20px;
  direction: rtl;
}

/* PAGE */
.container {
  max-width: 1450px;
  margin: auto;
}

/* ----------------------------------------------------------- */
/* HEADER ‚Äî VisionOS Floating Glass Header                     */
/* ----------------------------------------------------------- */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 26px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  margin-bottom: 22px;
}

.header-content {
  display: flex;
  flex-direction: column;
}

.header-title h1 {
  margin: 0;
  font-size: 2.2rem;
  font-weight: 700;
}
.header-title p {
  margin: 0;
  opacity: 0.6;
  font-size: 1.1rem;
}

.header img {
  height: 200px;
  border-radius: 00px;
  box-shadow: 0 6px 10px rgba(0,0,0,0.2);
}

/* ----------------------------------------------------------- */
/* UPLOAD ‚Äî Small VisionOS Panel                              */
/* ----------------------------------------------------------- */
.upload-box {
  width: 360px;
  margin: 0 auto 25px auto;
  padding: 16px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(14px);
  text-align: center;
  box-shadow: 0 6px 30px rgba(0,0,0,0.09);
}

.upload-box input {
  width: 100%;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid #d3e1ff;
  margin-bottom: 10px;
}

.upload-btn {
  background: var(--primary);
  color: white;
  padding: 8px 22px;
  border-radius: 999px;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(10,132,255,0.36);
  margin: 5px;
}

.loading {
  display: none;
  margin-top: 10px;
  color: var(--primary);
}

/* ----------------------------------------------------------- */
/* FILTER CARDS ‚Äî Glass Floating Cards                        */
/* ----------------------------------------------------------- */
.filters {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 22px;
}

.filter-card {
  padding: 20px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.filter-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.filter-card label {
  font-size: 0.9rem;
  opacity: 0.7;
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
}

.filter-card select {
  width: 100%;
  padding: 12px 16px;
  font-size: 0.9rem;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  color: var(--text);
}

/* ----------------------------------------------------------- */
/* KPI WIDGETS ‚Äî VisionOS Rounded Widgets                      */
/* ----------------------------------------------------------- */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
  gap: 14px;
  margin-bottom: 22px;
}

.kpi {
  padding: 18px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 6px 28px rgba(0,0,0,0.08);
}

.kpi-label {
  font-size: 0.75rem;
  opacity: 0.65;
}
.kpi-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

/* ----------------------------------------------------------- */
/* STATUS & PRIORITY DISTRIBUTION CARDS - SMALLER             */
/* ----------------------------------------------------------- */
.distribution-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}

.distribution-card {
  padding: 12px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  text-align: center;
}

.distribution-card h3 {
  margin: 0 0 12px 0;
  font-size: 1rem;
  color: var(--text);
}

.distribution-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  justify-items: center;
}

.distribution-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px;
  border-radius: 10px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  transition: transform 0.2s ease;
  min-width: 90px;
  min-height: 90px;
  text-align: center;
}

.distribution-item:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.2);
}

.distribution-color {
  width: 45px;
  height: 45px;
  border-radius: 8px;
  margin-bottom: 6px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  font-weight: bold;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.distribution-name {
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text);
}

.distribution-count {
  font-size: 1rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 2px;
}

.distribution-percentage {
  font-size: 0.7rem;
  opacity: 0.8;
  font-weight: 500;
}

/* ----------------------------------------------------------- */
/* CHART CARDS ‚Äî Full-width Glass Panels                      */
/* ----------------------------------------------------------- */
.chart-card {
  padding: 20px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  margin-bottom: 24px;
  box-shadow: 0 10px 35px rgba(0,0,0,0.09);
  direction: ltr;
}

.chart-card h3 {
  margin: 0 0 10px 0;
  font-size: 1.1rem;
  text-align: right;
  direction: rtl;
}

/* CHART Retina Fix */
canvas {
  width: 100% !important;
  height: 430px !important;
  aspect-ratio: 16/8;
  image-rendering: crisp-edges;
}

/* ----------------------------------------------------------- */
/* NEW: Two Column Layout for Category Charts                  */
/* ----------------------------------------------------------- */
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

.charts-row .chart-card {
  margin-bottom: 0;
}

/* ----------------------------------------------------------- */
/* NEW: Four Week Charts Layout                               */
/* ----------------------------------------------------------- */
.week-charts-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.week-chart-container {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 15px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.week-chart-header {
  text-align: center;
  font-weight: bold;
  margin-bottom: 15px;
  color: var(--text);
  font-size: 1.1rem;
}

.week-chart-canvas {
  width: 100% !important;
  height: 200px !important;
}

/* ----------------------------------------------------------- */
/* NEW: Vertical Category Cards with Percentage               */
/* ----------------------------------------------------------- */
.vertical-categories {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 8px;
}

.category-card {
  border-radius: 14px;
  padding: 18px;
  color: white;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.3);
  transition: transform 0.2s ease;
  cursor: pointer;
  direction: rtl;
  text-align: right;
  position: relative;
}

.category-card:hover {
  transform: translateY(-3px);
}

.category-card.selected {
  transform: scale(1.02);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  border: 2px solid rgba(255,255,255,0.5);
}

.category-card .category-name {
  font-size: 1rem;
  margin-bottom: 6px;
}

.category-card .category-count {
  font-size: 1.6rem;
  opacity: 0.9;
  margin-bottom: 4px;
}

.category-card .category-percentage {
  font-size: 0.85rem;
  opacity: 0.8;
  font-weight: 600;
}

/* ----------------------------------------------------------- */
/* NEW: Subcategory Treemap with Percentage                   */
/* ----------------------------------------------------------- */
.subcategory-treemap {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  padding: 8px;
  direction: rtl;
}

.subcategory-item {
  border-radius: 12px;
  padding: 14px;
  color: white;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  transition: transform 0.2s ease;
  text-align: center;
  position: relative;
}

.subcategory-item:hover {
  transform: translateY(-2px);
}

.subcategory-item .subcategory-name {
  font-size: 0.85rem;
  margin-bottom: 5px;
}

.subcategory-item .subcategory-count {
  font-size: 1.3rem;
  opacity: 0.9;
  margin-bottom: 3px;
}

.subcategory-item .subcategory-percentage {
  font-size: 0.75rem;
  opacity: 0.8;
  font-weight: 600;
}
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="header">
  <div class="header-content">
    <div class="header-title">
      <h1>Request Analysis Dashboard</h1>
      <p>Advanced Analytics for Maintenance & Service Requests</p>
    </div>
  </div>
  <img src="https://i.postimg.cc/pXn6s2NM/MAG.jpg">
</div>

<!-- UPLOAD -->
<div class="upload-box">
  <input type="file" id="jsonFile" accept=".json">
  <div>
    <button class="upload-btn" onclick="loadJSON()">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ</button>
    <button class="upload-btn" onclick="loadFromURL()">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑</button>
  </div>
  <div id="loading" class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>
</div>

<!-- FILTERS -->
<div class="filters" id="filtersSection" style="display:none;">
  <div class="filter-card">
    <label>üìÖ ÿßŸÑÿ¥Ÿáÿ±</label>
    <select id="monthFilter" onchange="updateDashboard()">
      <option value="">All Months</option>
    </select>
  </div>
  <div class="filter-card">
    <label>üó∫Ô∏è ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
    <select id="regionFilter" onchange="updateDashboard()">
      <option value="">All Regions</option>
    </select>
  </div>
  <div class="filter-card">
    <label>üìç Zone</label>
    <select id="zoneFilter" onchange="updateDashboard()">
      <option value="">All Zones</option>
    </select>
  </div>
</div>

<!-- KPIs -->
<div class="kpi-row" id="kpiRow" style="display:none;">
  <div class="kpi"><div class="kpi-label">Total</div><div class="kpi-value" id="kpiTotal">0</div></div>
  <div class="kpi"><div class="kpi-label">Resolved</div><div class="kpi-value" id="kpiResolved">0</div></div>
  <div class="kpi"><div class="kpi-label">Open</div><div class="kpi-value" id="kpiOpen">0</div></div>
  <div class="kpi"><div class="kpi-label">High Priority</div><div class="kpi-value" id="kpiHigh">0</div></div>
</div>

<!-- STATUS & PRIORITY DISTRIBUTION -->
<div class="distribution-section" id="distributionSection" style="display:none;">
  <!-- PRIORITY DISTRIBUTION -->
  <div class="distribution-card">
    <h3>Priority Distribution</h3>
    <div class="distribution-grid" id="priorityDistribution"></div>
  </div>
  
  <!-- STATUS DISTRIBUTION -->
  <div class="distribution-card">
    <h3>Status Distribution</h3>
    <div class="distribution-grid" id="statusDistribution"></div>
  </div>
</div>

<!-- CHARTS -->
<div id="chartsSection" style="display:none;">

  <!-- TIME CHART - 4 WEEK CHARTS -->
  <div class="chart-card">
    <h3>Requests Over Time - Weekly Analysis</h3>
    <div class="week-charts-grid" id="weekChartsGrid"></div>
  </div>

  <!-- CATEGORY & SUBCATEGORY ROW -->
  <div class="charts-row">
    <!-- CATEGORY VERTICAL CARDS -->
    <div class="chart-card">
      <h3>Requests by Category</h3>
      <div id="categoryContainer" class="vertical-categories"></div>
    </div>

    <!-- SUBCATEGORY TREEMAP -->
    <div class="chart-card">
      <h3>Requests by Subcategory</h3>
      <div id="subcategoryContainer" class="subcategory-treemap"></div>
    </div>
  </div>

  <!-- SCHOOLS ROW -->
  <div class="chart-card">
    <h3>Top Schools by Requests</h3>
    <canvas id="chartSchools"></canvas>
  </div>

</div>

</div>

<script>
/* ----------------------------------------------------------- */
/* Retina Fix */
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

// Define glassmorphism color palette
const glassColors = [
  'rgba(10, 132, 255, 0.7)',   // Blue
  'rgba(52, 199, 89, 0.7)',    // Green
  'rgba(255, 149, 0, 0.7)',    // Orange
  'rgba(255, 59, 48, 0.7)',    // Red
  'rgba(88, 86, 214, 0.7)',    // Purple
  'rgba(0, 199, 190, 0.7)',    // Teal
  'rgba(255, 45, 85, 0.7)',    // Pink
  'rgba(175, 82, 222, 0.7)',   // Violet
  'rgba(90, 200, 250, 0.7)',   // Light Blue
  'rgba(255, 204, 0, 0.7)'     // Yellow
];

const glassBorders = [
  'rgba(10, 132, 255, 0.9)',
  'rgba(52, 199, 89, 0.9)',
  'rgba(255, 149, 0, 0.9)',
  'rgba(255, 59, 48, 0.9)',
  'rgba(88, 86, 214, 0.9)',
  'rgba(0, 199, 190, 0.9)',
  'rgba(255, 45, 85, 0.9)',
  'rgba(175, 82, 222, 0.9)',
  'rgba(90, 200, 250, 0.9)',
  'rgba(255, 204, 0, 0.9)'
];

// Global variables
let rawData = [];
let selectedCategory = null;
let chartSchools;
let weekCharts = [];

function fixCanvasResolution(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
}

/* ----------------------------------------------------------- */
/* SMART BOX SIZING - ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ±ÿ®ÿπ Ÿäÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿ±ŸÇŸÖ               */
/* ----------------------------------------------------------- */
function calculateBoxSize(number) {
  const numLength = number.toString().length;
  
  // ŸÇÿßÿπÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
  if (numLength >= 4) {          // ÿ£ÿ±ŸÇÿßŸÖ ŸÖŸÜ 4 ÿÆÿßŸÜÿßÿ™ ŸÅÿ£ŸÉÿ´ÿ± (1000+)
    return { size: 55, fontSize: 1.0 };
  } else if (numLength === 3) {  // ÿ£ÿ±ŸÇÿßŸÖ 3 ÿÆÿßŸÜÿßÿ™ (100-999)
    return { size: 50, fontSize: 1.1 };
  } else if (numLength === 2) {  // ÿ£ÿ±ŸÇÿßŸÖ ÿÆÿßŸÜÿ™ŸäŸÜ (10-99)
    return { size: 45, fontSize: 1.2 };
  } else {                       // ÿ£ÿ±ŸÇÿßŸÖ ÿÆÿßŸÜÿ© Ÿàÿßÿ≠ÿØÿ© (0-9)
    return { size: 40, fontSize: 1.3 };
  }
}

/* ----------------------------------------------------------- */
/* WEEKLY DATA PREPARATION - ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ      */
/* ----------------------------------------------------------- */
function prepareWeeklyData(data) {
  const weeks = [
    { 
      name: 'Week 1', 
      days: [1, 2, 3, 4, 5, 6, 7],
      counts: [0, 0, 0, 0, 0, 0, 0],
      resolved: [0, 0, 0, 0, 0, 0, 0],
      pending: [0, 0, 0, 0, 0, 0, 0], // In Progress + Pending + Assigned
      highPriority: [0, 0, 0, 0, 0, 0, 0]
    },
    { 
      name: 'Week 2', 
      days: [8, 9, 10, 11, 12, 13, 14],
      counts: [0, 0, 0, 0, 0, 0, 0],
      resolved: [0, 0, 0, 0, 0, 0, 0],
      pending: [0, 0, 0, 0, 0, 0, 0], // In Progress + Pending + Assigned
      highPriority: [0, 0, 0, 0, 0, 0, 0]
    },
    { 
      name: 'Week 3', 
      days: [15, 16, 17, 18, 19, 20, 21],
      counts: [0, 0, 0, 0, 0, 0, 0],
      resolved: [0, 0, 0, 0, 0, 0, 0],
      pending: [0, 0, 0, 0, 0, 0, 0], // In Progress + Pending + Assigned
      highPriority: [0, 0, 0, 0, 0, 0, 0]
    },
    { 
      name: 'Week 4', 
      days: [22, 23, 24, 25, 26, 27, 28, 29, 30, 31],
      counts: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      resolved: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      pending: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // In Progress + Pending + Assigned
      highPriority: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    }
  ];

  // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÑŸÉŸÑ ŸäŸàŸÖ Ÿàÿ≠ÿßŸÑÿ© ŸÉŸÑ ÿ∑ŸÑÿ®
  data.forEach(request => {
    if (request["Created Date"]) {
      const createdDate = new Date(request["Created Date"]);
      if (!isNaN(createdDate)) {
        const dayOfMonth = createdDate.getDate();
        const status = request["Ticket Status"] || "";
        const isResolved = status === "Resolved";
        const isPending = ["In Progress", "Pending", "Assigned"].includes(status);
        const isHighPriority = request["Priority"] === "High";
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸäŸàŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ŸÅŸä ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ
        weeks.forEach(week => {
          const dayIndex = week.days.indexOf(dayOfMonth);
          if (dayIndex !== -1) {
            week.counts[dayIndex]++;
            if (isResolved) {
              week.resolved[dayIndex]++;
            }
            if (isPending) {
              week.pending[dayIndex]++;
            }
            if (isHighPriority) {
              week.highPriority[dayIndex]++;
            }
          }
        });
      }
    }
  });

  return weeks;
}

/* ----------------------------------------------------------- */
/* CREATE WEEKLY CHARTS - ÿ•ŸÜÿ¥ÿßÿ° 4 ÿ¥ÿßÿ±ÿ™ÿßÿ™ ŸÖŸÜŸÅÿµŸÑÿ© ŸÑŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ      */
/* ----------------------------------------------------------- */
function createWeeklyCharts(data) {
  const weeklyData = prepareWeeklyData(data);
  const container = document.getElementById('weekChartsGrid');
  container.innerHTML = '';

  // ÿ™ÿØŸÖŸäÿ± ÿßŸÑÿ¥ÿßÿ±ÿ™ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
  weekCharts.forEach(chart => chart && chart.destroy());
  weekCharts = [];

  // ÿ•ŸÜÿ¥ÿßÿ° ÿ¥ÿßÿ±ÿ™ ŸÑŸÉŸÑ ÿ£ÿ≥ÿ®Ÿàÿπ
  weeklyData.forEach((week, weekIndex) => {
    if (week.days.length === 0) return;

    const weekContainer = document.createElement('div');
    weekContainer.className = 'week-chart-container';

    const weekHeader = document.createElement('div');
    weekHeader.className = 'week-chart-header';
    weekHeader.textContent = `${week.name} (Days ${week.days[0]}-${week.days[week.days.length-1]})`;

    const canvas = document.createElement('canvas');
    canvas.className = 'week-chart-canvas';
    canvas.setAttribute('data-week-index', weekIndex);
    
    weekContainer.appendChild(weekHeader);
    weekContainer.appendChild(canvas);
    container.appendChild(weekContainer);

    // ÿ•ÿπÿØÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿßÿ±ÿ™
    const labels = week.days.map(day => `Day ${day}`);
    const resolvedData = week.resolved;
    const pendingData = week.pending; // ÿßŸÑÿ¢ŸÜ Ÿáÿ∞ÿß ŸÖÿ¨ŸÖŸàÿπ In Progress + Pending + Assigned
    const totalData = week.counts;
    const highPriorityData = week.highPriority;

    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¥ÿßÿ±ÿ™
    const ctx = canvas.getContext('2d');
    fixCanvasResolution(canvas);

    const weekChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Resolved',
            data: resolvedData,
            backgroundColor: 'rgba(52, 199, 89, 0.7)',
            borderColor: 'rgba(52, 199, 89, 0.9)',
            borderWidth: 1
          },
          {
            label: 'Pending',
            data: pendingData,
            backgroundColor: 'rgba(255, 149, 0, 0.7)',
            borderColor: 'rgba(255, 149, 0, 0.9)',
            borderWidth: 1
          },
          {
            label: 'Total',
            type: 'line',
            data: totalData,
            borderColor: 'rgba(10, 132, 255, 0.9)',
            backgroundColor: 'rgba(10, 132, 255, 0.1)',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(10, 132, 255, 0.9)',
            fill: false,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255,255,255,0.1)'
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255,255,255,0.1)'
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: 'var(--text)'
            }
          },
          tooltip: {
            enabled: true,
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#000',
            bodyColor: '#000',
            borderColor: 'rgba(255, 255, 255, 0.3)',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              title: function(tooltipItems) {
                const tooltipItem = tooltipItems[0];
                const dayIndex = tooltipItem.dataIndex;
                const day = week.days[dayIndex];
                const total = week.counts[dayIndex];
                const resolved = week.resolved[dayIndex];
                const pending = week.pending[dayIndex];
                const highPriority = week.highPriority[dayIndex];
                
                return `Day ${day} - ${week.name}\nTotal: ${total} requests`;
              },
              beforeBody: function(tooltipItems) {
                const tooltipItem = tooltipItems[0];
                const dayIndex = tooltipItem.dataIndex;
                const total = week.counts[dayIndex];
                const resolved = week.resolved[dayIndex];
                const pending = week.pending[dayIndex];
                const highPriority = week.highPriority[dayIndex];
                
                const resolvedPercentage = total > 0 ? ((resolved / total) * 100).toFixed(1) : 0;
                const pendingPercentage = total > 0 ? ((pending / total) * 100).toFixed(1) : 0;
                const highPriorityPercentage = total > 0 ? ((highPriority / total) * 100).toFixed(1) : 0;
                
                return [
                  `Resolved: ${resolved} (${resolvedPercentage}%)`,
                  `Pending: ${pending} (${pendingPercentage}%)`,
                  `High Priority: ${highPriority} (${highPriorityPercentage}%)`
                ];
              },
              label: function(context) {
                // Ÿáÿ∞ÿß ÿ≥Ÿäÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ© ŸÑŸÉŸÑ dataset
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        }
      }
    });

    weekCharts.push(weekChart);
  });
}

/* ----------------------------------------------------------- */
/* PREPARE SCHOOLS DATA - ÿ™ÿ¨ŸáŸäÿ≤ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿØÿßÿ±ÿ≥ ŸÖÿπ Subcategories */
/* ----------------------------------------------------------- */
function prepareSchoolsData(data) {
  const schools = {};
  
  data.forEach(request => {
    const schoolName = request["School Name"] || request["Building Name"] || request["School Number"] || "Unknown";
    const subCategory = request["Sub Category"] || "Unknown";
    
    if (!schools[schoolName]) {
      schools[schoolName] = {
        total: 0,
        subcategories: {},
        resolved: 0,
        pending: 0,
        highPriority: 0
      };
    }
    
    schools[schoolName].total++;
    
    // ÿ≠ÿ≥ÿßÿ® Subcategories
    if (!schools[schoolName].subcategories[subCategory]) {
      schools[schoolName].subcategories[subCategory] = 0;
    }
    schools[schoolName].subcategories[subCategory]++;
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿßŸÑÿßÿ™
    const status = request["Ticket Status"] || "";
    if (status === "Resolved") {
      schools[schoolName].resolved++;
    } else if (["In Progress", "Pending", "Assigned"].includes(status)) {
      schools[schoolName].pending++;
    }
    
    if (request["Priority"] === "High") {
      schools[schoolName].highPriority++;
    }
  });
  
  return schools;
}

/* ----------------------------------------------------------- */
/* LOAD FROM URL - ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖÿ≠ÿØÿØ            */
/* ----------------------------------------------------------- */
function loadFromURL() {
  const loadingElement = document.getElementById('loading');
  loadingElement.style.display = 'block';

  // ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  const url = 'https://app.netlify.com/projects/magrequests/deploys/';
  
  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      rawData = data;
      loadingElement.style.display = 'none';
      
      buildFilters(rawData);
      document.getElementById("filtersSection").style.display = "grid";
      document.getElementById("kpiRow").style.display = "grid";
      document.getElementById("distributionSection").style.display = "grid";
      document.getElementById("chartsSection").style.display = "block";

      updateDashboard();
    })
    .catch(error => {
      loadingElement.style.display = 'none';
      alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑: ' + error.message);
      console.error('Error loading data from URL:', error);
    });
}

/* ----------------------------------------------------------- */
function loadJSON(){
  const file=document.getElementById("jsonFile").files[0];
  if(!file){alert("ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ JSON");return;}

  let reader=new FileReader();
  reader.onload=e=>{
    rawData=JSON.parse(e.target.result);

    buildFilters(rawData);
    document.getElementById("filtersSection").style.display="grid";
    document.getElementById("kpiRow").style.display="grid";
    document.getElementById("distributionSection").style.display="grid";
    document.getElementById("chartsSection").style.display="block";

    updateDashboard();
  };
  reader.readAsText(file);
}

/* ----------------------------------------------------------- */
/* Build Filters */
function buildFilters(d){
  const months=new Set();
  const regions=new Set();
  const zones=new Set();

  d.forEach(r=>{
    if(r["Created Date"]){
      const dd=new Date(r["Created Date"]);
      if(!isNaN(dd)) {
        const month = `${String(dd.getMonth() + 1).padStart(2, '0')}-${dd.getFullYear()}`;
        months.add(month);
      }
    }
    if(r["Requester Department"]) regions.add(r["Requester Department"]);
    if(r["Zone"]) zones.add(r["Zone"]);
  });

  fillSelect("monthFilter", months, "All Months");
  fillSelect("regionFilter", regions, "All Regions");
  fillSelect("zoneFilter", zones, "All Zones");
}

function fillSelect(id, set, label){
  const s = document.getElementById(id);
  s.innerHTML = `<option value="">${label}</option>`;
  [...set].sort().forEach(v => {
    s.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

/* ----------------------------------------------------------- */
function updateDashboard(){
  const m = document.getElementById("monthFilter").value;
  const r = document.getElementById("regionFilter").value;
  const z = document.getElementById("zoneFilter").value;

  // Filter data based on selections
  let filteredData = rawData.filter(x => {
    let ok = true;
    
    // Month filter
    if (m) {
      const date = new Date(x["Created Date"]);
      if (!isNaN(date)) {
        const itemMonth = `${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
        ok = ok && (itemMonth === m);
      } else {
        ok = false;
      }
    }
    
    // Region filter
    if (r) ok = ok && (x["Requester Department"] === r);
    
    // Zone filter
    if (z) ok = ok && (x["Zone"] === z);
    
    // Category filter
    if (selectedCategory) ok = ok && (x["Category"] === selectedCategory);
    
    return ok;
  });

  // If no data matches the filters, show zeros
  if (filteredData.length === 0 && (m || r || z || selectedCategory)) {
    filteredData = [];
  }

  updateKPIs(filteredData);
  updateDistributions(filteredData);
  drawCharts(filteredData);
}

/* ----------------------------------------------------------- */
function updateKPIs(d){
  document.getElementById("kpiTotal").textContent = d.length;
  document.getElementById("kpiResolved").textContent = d.filter(x => x["Ticket Status"] === "Resolved").length;
  document.getElementById("kpiOpen").textContent = d.filter(x => ["In Progress", "Pending", "Assigned"].includes(x["Ticket Status"])).length;
  document.getElementById("kpiHigh").textContent = d.filter(x => x["Priority"] === "High").length;
}

/* ----------------------------------------------------------- */
function updateDistributions(data){
  // Priority Distribution
  const priorityData = {};
  data.forEach(r => {
    const p = r["Priority"] || "Unknown";
    priorityData[p] = (priorityData[p] || 0) + 1;
  });

  const totalPriority = data.length;
  const priorityContainer = document.getElementById('priorityDistribution');
  priorityContainer.innerHTML = '';

  Object.keys(priorityData).forEach((priority, index) => {
    const count = priorityData[priority];
    const percentage = totalPriority > 0 ? ((count / totalPriority) * 100).toFixed(1) : '0.0';
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑÿ±ŸÇŸÖ
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[index % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${priority}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    priorityContainer.appendChild(item);
  });

  // Status Distribution
  const statusData = {};
  data.forEach(r => {
    const s = r["Ticket Status"] || "Unknown";
    statusData[s] = (statusData[s] || 0) + 1;
  });

  const totalStatus = data.length;
  const statusContainer = document.getElementById('statusDistribution');
  statusContainer.innerHTML = '';

  // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÄ Status ÿ•ŸÑŸâ ÿµŸÅŸäŸÜ (3 ŸÅŸàŸÇ Ÿà3 ÿ™ÿ≠ÿ™)
  const statusEntries = Object.entries(statusData);
  const firstRow = statusEntries.slice(0, 3);
  const secondRow = statusEntries.slice(3, 6);

  // ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ
  firstRow.forEach(([status, count], index) => {
    const percentage = totalStatus > 0 ? ((count / totalStatus) * 100).toFixed(1) : '0.0';
    
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[(index + 3) % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${status}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    statusContainer.appendChild(item);
  });

  // ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä
  secondRow.forEach(([status, count], index) => {
    const percentage = totalStatus > 0 ? ((count / totalStatus) * 100).toFixed(1) : '0.0';
    
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[(index + 6) % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${status}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    statusContainer.appendChild(item);
  });
}

/* ----------------------------------------------------------- */
/* Draw Charts */
function drawCharts(data){
  const kill = c => c && c.destroy();

  /* WEEKLY CHARTS - 4 ÿ¥ÿßÿ±ÿ™ÿßÿ™ ŸÖŸÜŸÅÿµŸÑÿ© */
  createWeeklyCharts(data);

  /* CATEGORY VERTICAL CARDS with Percentage */
  const catData = {};
  data.forEach(r => {
    const cat = r["Category"] || "Unknown";
    catData[cat] = (catData[cat] || 0) + 1;
  });

  const totalCategories = data.length;
  
  // Sort categories by count
  const sortedCats = Object.entries(catData).sort((a, b) => b[1] - a[1]);
  
  // Create vertical category cards
  const categoryContainer = document.getElementById('categoryContainer');
  categoryContainer.innerHTML = '';
  
  sortedCats.forEach(([category, count], index) => {
    const colorIndex = index % glassColors.length;
    const percentage = totalCategories > 0 ? ((count / totalCategories) * 100).toFixed(1) : '0.0';
    
    const item = document.createElement('div');
    item.className = `category-card ${selectedCategory === category ? 'selected' : ''}`;
    item.style.background = `linear-gradient(135deg, ${glassColors[colorIndex]}, ${glassBorders[colorIndex]})`;
    item.innerHTML = `
      <div class="category-name">${category}</div>
      <div class="category-count">${count}</div>
      <div class="category-percentage">${percentage}%</div>
    `;
    
    // Add click event for category filtering
    item.onclick = function() {
      if (selectedCategory === category) {
        // Deselect if clicking the same category
        selectedCategory = null;
      } else {
        selectedCategory = category;
      }
      updateDashboard();
    };
    
    categoryContainer.appendChild(item);
  });

  /* SUBCATEGORY TREEMAP with Percentage */
  const subData = {};
  data.forEach(r => {
    const sub = r["Sub Category"] || "Unknown";
    subData[sub] = (subData[sub] || 0) + 1;
  });

  const totalSubcategories = data.length;
  
  // Sort subcategories by count
  const sortedSubs = Object.entries(subData).sort((a, b) => b[1] - a[1]);
  
  // Create subcategory treemap
  const subcategoryContainer = document.getElementById('subcategoryContainer');
  subcategoryContainer.innerHTML = '';
  
  sortedSubs.forEach(([subcategory, count], index) => {
    const colorIndex = (index + 2) % glassColors.length;
    const percentage = totalSubcategories > 0 ? ((count / totalSubcategories) * 100).toFixed(1) : '0.0';
    
    const item = document.createElement('div');
    item.className = 'subcategory-item';
    item.style.background = `linear-gradient(135deg, ${glassColors[colorIndex]}, ${glassBorders[colorIndex]})`;
    item.innerHTML = `
      <div class="subcategory-name">${subcategory}</div>
      <div class="subcategory-count">${count}</div>
      <div class="subcategory-percentage">${percentage}%</div>
    `;
    subcategoryContainer.appendChild(item);
  });

  /* TOP SCHOOLS - Horizontal Bar Chart ŸÖÿπ ÿ™ŸàŸÑÿ™Ÿäÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© */
  const schoolsData = prepareSchoolsData(data);
  const sortedSchools = Object.entries(schoolsData)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 10);

  const totalAllRequests = data.length;

  let c4 = document.getElementById("chartSchools");
  fixCanvasResolution(c4);
  kill(chartSchools);

  // Prepare colors for schools
  const schoolColors = sortedSchools.map((_, i) => glassColors[i % glassColors.length]);
  const schoolBorders = sortedSchools.map((_, i) => glassBorders[i % glassBorders.length]);

  chartSchools = new Chart(c4, {
    type: "bar",
    data: {
      labels: sortedSchools.map(x => x[0]),
      datasets: [{
        data: sortedSchools.map(x => x[1].total),
        backgroundColor: schoolColors,
        borderColor: schoolBorders,
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#000',
          bodyColor: '#000',
          borderColor: 'rgba(255, 255, 255, 0.3)',
          borderWidth: 1,
          padding: 12,
          displayColors: false,
          callbacks: {
            title: function(tooltipItems) {
              const tooltipItem = tooltipItems[0];
              const schoolIndex = tooltipItem.dataIndex;
              const schoolName = sortedSchools[schoolIndex][0];
              const schoolData = sortedSchools[schoolIndex][1];
              const percentage = totalAllRequests > 0 ? ((schoolData.total / totalAllRequests) * 100).toFixed(1) : 0;
              
              return `${schoolName}\nTotal: ${schoolData.total} requests (${percentage}%)`;
            },
            beforeBody: function(tooltipItems) {
              const tooltipItem = tooltipItems[0];
              const schoolIndex = tooltipItem.dataIndex;
              const schoolData = sortedSchools[schoolIndex][1];
              
              const resolvedPercentage = schoolData.total > 0 ? ((schoolData.resolved / schoolData.total) * 100).toFixed(1) : 0;
              const pendingPercentage = schoolData.total > 0 ? ((schoolData.pending / schoolData.total) * 100).toFixed(1) : 0;
              const highPriorityPercentage = schoolData.total > 0 ? ((schoolData.highPriority / schoolData.total) * 100).toFixed(1) : 0;
              
              return [
                `Resolved: ${schoolData.resolved} (${resolvedPercentage}%)`,
                `Pending: ${schoolData.pending} (${pendingPercentage}%)`,
                `High Priority: ${schoolData.highPriority} (${highPriorityPercentage}%)`
              ];
            },
            afterBody: function(tooltipItems) {
              const tooltipItem = tooltipItems[0];
              const schoolIndex = tooltipItem.dataIndex;
              const schoolData = sortedSchools[schoolIndex][1];
              
              // ÿπÿ±ÿ∂ ÿ£ŸáŸÖ 3 subcategories
              const topSubcategories = Object.entries(schoolData.subcategories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
              
              if (topSubcategories.length > 0) {
                const subcategoryLines = ['', 'Top Subcategories:'];
                topSubcategories.forEach(([subcat, count]) => {
                  const subcatPercentage = schoolData.total > 0 ? ((count / schoolData.total) * 100).toFixed(1) : 0;
                  subcategoryLines.push(`‚Ä¢ ${subcat}: ${count} (${subcatPercentage}%)`);
                });
                return subcategoryLines;
              }
              
              return [];
            },
            label: function(context) {
              return ''; // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÄ label ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        }
      }
    }
  });
}
</script>

</body>
</html>