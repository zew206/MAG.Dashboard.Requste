<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Request Analysis Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ----------------------------------------------------------- */
/*  VISIONOS GLOBAL STYLE ‚Äî BLUR + LIGHT + SHADOWS             */
/* ----------------------------------------------------------- */
:root {
  --glass: rgba(255,255,255,0.22);
  --glass-border: rgba(255,255,255,0.32);
  --glass-dark: rgba(255,255,255,0.15);
  --text: #0f0f0f;
  --primary: #0a84ff;
  --bg1: #fafdff;
  --bg2: #eef4ff;
  --radius: 22px;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  color: var(--text);
  padding: 20px;
  direction: rtl;
}

/* PAGE */
.container {
  max-width: 1450px;
  margin: auto;
}

/* ----------------------------------------------------------- */
/* HEADER ‚Äî VisionOS Floating Glass Header                     */
/* ----------------------------------------------------------- */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 26px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  margin-bottom: 22px;
}

.header-content {
  display: flex;
  flex-direction: column;
}

.header-title h1 {
  margin: 0;
  font-size: 2.2rem;
  font-weight: 700;
}
.header-title p {
  margin: 0;
  opacity: 0.6;
  font-size: 1.1rem;
}

.header img {
  height: 120px;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* ----------------------------------------------------------- */
/* UPLOAD ‚Äî Small VisionOS Panel                              */
/* ----------------------------------------------------------- */
.upload-box {
  width: 360px;
  margin: 0 auto 25px auto;
  padding: 16px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(14px);
  text-align: center;
  box-shadow: 0 6px 30px rgba(0,0,0,0.09);
}

.upload-box input {
  width: 100%;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid #d3e1ff;
  margin-bottom: 10px;
}

.upload-btn {
  background: var(--primary);
  color: white;
  padding: 8px 22px;
  border-radius: 999px;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(10,132,255,0.36);
}

/* ----------------------------------------------------------- */
/* FILTER CARDS ‚Äî Glass Floating Cards                        */
/* ----------------------------------------------------------- */
.filters {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 22px;
}

.filter-card {
  padding: 20px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.filter-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.filter-card label {
  font-size: 0.9rem;
  opacity: 0.7;
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
}

.filter-card select {
  width: 100%;
  padding: 12px 16px;
  font-size: 0.9rem;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  color: var(--text);
}

/* ----------------------------------------------------------- */
/* KPI WIDGETS ‚Äî VisionOS Rounded Widgets                      */
/* ----------------------------------------------------------- */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
  gap: 14px;
  margin-bottom: 22px;
}

.kpi {
  padding: 18px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 6px 28px rgba(0,0,0,0.08);
}

.kpi-label {
  font-size: 0.75rem;
  opacity: 0.65;
}
.kpi-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

/* ----------------------------------------------------------- */
/* STATUS & PRIORITY DISTRIBUTION CARDS - SMALLER             */
/* ----------------------------------------------------------- */
.distribution-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}

.distribution-card {
  padding: 12px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  text-align: center;
}

.distribution-card h3 {
  margin: 0 0 12px 0;
  font-size: 1rem;
  color: var(--text);
}

.distribution-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  justify-items: center;
}

.distribution-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px;
  border-radius: 10px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  transition: transform 0.2s ease;
  min-width: 90px;
  min-height: 90px;
  text-align: center;
}

.distribution-item:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.2);
}

.distribution-color {
  width: 45px;
  height: 45px;
  border-radius: 8px;
  margin-bottom: 6px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  font-weight: bold;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.distribution-name {
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text);
}

.distribution-count {
  font-size: 1rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 2px;
}

.distribution-percentage {
  font-size: 0.7rem;
  opacity: 0.8;
  font-weight: 500;
}

/* ----------------------------------------------------------- */
/* CHART CARDS ‚Äî Full-width Glass Panels                      */
/* ----------------------------------------------------------- */
.chart-card {
  padding: 20px;
  border-radius: var(--radius);
  background: var(--glass);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(18px);
  margin-bottom: 24px;
  box-shadow: 0 10px 35px rgba(0,0,0,0.09);
  direction: ltr;
}

.chart-card h3 {
  margin: 0 0 10px 0;
  font-size: 1.1rem;
  text-align: right;
  direction: rtl;
}

/* CHART Retina Fix */
canvas {
  width: 100% !important;
  height: 430px !important;
  aspect-ratio: 16/8;
  image-rendering: crisp-edges;
}

/* ----------------------------------------------------------- */
/* NEW: Two Column Layout for Category Charts                  */
/* ----------------------------------------------------------- */
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

.charts-row .chart-card {
  margin-bottom: 0;
}

/* ----------------------------------------------------------- */
/* NEW: Vertical Category Cards with Percentage               */
/* ----------------------------------------------------------- */
.vertical-categories {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 8px;
}

.category-card {
  border-radius: 14px;
  padding: 18px;
  color: white;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.3);
  transition: transform 0.2s ease;
  cursor: pointer;
  direction: rtl;
  text-align: right;
  position: relative;
}

.category-card:hover {
  transform: translateY(-3px);
}

.category-card.selected {
  transform: scale(1.02);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  border: 2px solid rgba(255,255,255,0.5);
}

.category-card .category-name {
  font-size: 1rem;
  margin-bottom: 6px;
}

.category-card .category-count {
  font-size: 1.6rem;
  opacity: 0.9;
  margin-bottom: 4px;
}

.category-card .category-percentage {
  font-size: 0.85rem;
  opacity: 0.8;
  font-weight: 600;
}

/* ----------------------------------------------------------- */
/* NEW: Subcategory Treemap with Percentage                   */
/* ----------------------------------------------------------- */
.subcategory-treemap {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  padding: 8px;
  direction: rtl;
}

.subcategory-item {
  border-radius: 12px;
  padding: 14px;
  color: white;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  transition: transform 0.2s ease;
  text-align: center;
  position: relative;
}

.subcategory-item:hover {
  transform: translateY(-2px);
}

.subcategory-item .subcategory-name {
  font-size: 0.85rem;
  margin-bottom: 5px;
}

.subcategory-item .subcategory-count {
  font-size: 1.3rem;
  opacity: 0.9;
  margin-bottom: 3px;
}

.subcategory-item .subcategory-percentage {
  font-size: 0.75rem;
  opacity: 0.8;
  font-weight: 600;
}
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="header">
  <div class="header-content">
    <div class="header-title">
      <h1>Request Analysis Dashboard</h1>
      <p>Advanced Analytics for Maintenance & Service Requests</p>
    </div>
  </div>
  <img src="https://i.postimg.cc/2qbZRKwZ/your-logo.png">
</div>

<!-- UPLOAD -->
<div class="upload-box">
  <input type="file" id="jsonFile" accept=".json">
  <button class="upload-btn" onclick="loadJSON()">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
</div>

<!-- FILTERS -->
<div class="filters" id="filtersSection" style="display:none;">
  <div class="filter-card">
    <label>üìÖ ÿßŸÑÿ¥Ÿáÿ±</label>
    <select id="monthFilter" onchange="updateDashboard()">
      <option value="">All Months</option>
    </select>
  </div>
  <div class="filter-card">
    <label>üó∫Ô∏è ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
    <select id="regionFilter" onchange="updateDashboard()">
      <option value="">All Regions</option>
    </select>
  </div>
  <div class="filter-card">
    <label>üìç Zone</label>
    <select id="zoneFilter" onchange="updateDashboard()">
      <option value="">All Zones</option>
    </select>
  </div>
</div>

<!-- KPIs -->
<div class="kpi-row" id="kpiRow" style="display:none;">
  <div class="kpi"><div class="kpi-label">Total</div><div class="kpi-value" id="kpiTotal">0</div></div>
  <div class="kpi"><div class="kpi-label">Resolved</div><div class="kpi-value" id="kpiResolved">0</div></div>
  <div class="kpi"><div class="kpi-label">Open</div><div class="kpi-value" id="kpiOpen">0</div></div>
  <div class="kpi"><div class="kpi-label">High Priority</div><div class="kpi-value" id="kpiHigh">0</div></div>
</div>

<!-- STATUS & PRIORITY DISTRIBUTION -->
<div class="distribution-section" id="distributionSection" style="display:none;">
  <!-- PRIORITY DISTRIBUTION -->
  <div class="distribution-card">
    <h3>Priority Distribution</h3>
    <div class="distribution-grid" id="priorityDistribution"></div>
  </div>
  
  <!-- STATUS DISTRIBUTION -->
  <div class="distribution-card">
    <h3>Status Distribution</h3>
    <div class="distribution-grid" id="statusDistribution"></div>
  </div>
</div>

<!-- CHARTS -->
<div id="chartsSection" style="display:none;">

  <!-- TIME CHART -->
  <div class="chart-card">
    <h3>Requests Over Time</h3>
    <canvas id="chartTime"></canvas>
  </div>

  <!-- CATEGORY & SUBCATEGORY ROW -->
  <div class="charts-row">
    <!-- CATEGORY VERTICAL CARDS -->
    <div class="chart-card">
      <h3>Requests by Category</h3>
      <div id="categoryContainer" class="vertical-categories"></div>
    </div>

    <!-- SUBCATEGORY TREEMAP -->
    <div class="chart-card">
      <h3>Requests by Subcategory</h3>
      <div id="subcategoryContainer" class="subcategory-treemap"></div>
    </div>
  </div>

  <!-- SCHOOLS ROW -->
  <div class="chart-card">
    <h3>Top Schools by Requests</h3>
    <canvas id="chartSchools"></canvas>
  </div>

</div>

</div>

<script>
/* ----------------------------------------------------------- */
/* Retina Fix */
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

// Define glassmorphism color palette
const glassColors = [
  'rgba(10, 132, 255, 0.7)',   // Blue
  'rgba(52, 199, 89, 0.7)',    // Green
  'rgba(255, 149, 0, 0.7)',    // Orange
  'rgba(255, 59, 48, 0.7)',    // Red
  'rgba(88, 86, 214, 0.7)',    // Purple
  'rgba(0, 199, 190, 0.7)',    // Teal
  'rgba(255, 45, 85, 0.7)',    // Pink
  'rgba(175, 82, 222, 0.7)',   // Violet
  'rgba(90, 200, 250, 0.7)',   // Light Blue
  'rgba(255, 204, 0, 0.7)'     // Yellow
];

const glassBorders = [
  'rgba(10, 132, 255, 0.9)',
  'rgba(52, 199, 89, 0.9)',
  'rgba(255, 149, 0, 0.9)',
  'rgba(255, 59, 48, 0.9)',
  'rgba(88, 86, 214, 0.9)',
  'rgba(0, 199, 190, 0.9)',
  'rgba(255, 45, 85, 0.9)',
  'rgba(175, 82, 222, 0.9)',
  'rgba(90, 200, 250, 0.9)',
  'rgba(255, 204, 0, 0.9)'
];

// Global variables
let rawData = [];
let selectedCategory = null;
let chartTime, chartSchools;

function fixCanvasResolution(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
}

/* ----------------------------------------------------------- */
/* SMART BOX SIZING - ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ±ÿ®ÿπ Ÿäÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿ±ŸÇŸÖ               */
/* ----------------------------------------------------------- */
function calculateBoxSize(number) {
  const numLength = number.toString().length;
  
  // ŸÇÿßÿπÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
  if (numLength >= 4) {          // ÿ£ÿ±ŸÇÿßŸÖ ŸÖŸÜ 4 ÿÆÿßŸÜÿßÿ™ ŸÅÿ£ŸÉÿ´ÿ± (1000+)
    return { size: 55, fontSize: 1.0 };
  } else if (numLength === 3) {  // ÿ£ÿ±ŸÇÿßŸÖ 3 ÿÆÿßŸÜÿßÿ™ (100-999)
    return { size: 50, fontSize: 1.1 };
  } else if (numLength === 2) {  // ÿ£ÿ±ŸÇÿßŸÖ ÿÆÿßŸÜÿ™ŸäŸÜ (10-99)
    return { size: 45, fontSize: 1.2 };
  } else {                       // ÿ£ÿ±ŸÇÿßŸÖ ÿÆÿßŸÜÿ© Ÿàÿßÿ≠ÿØÿ© (0-9)
    return { size: 40, fontSize: 1.3 };
  }
}

/* ----------------------------------------------------------- */
/* GROUP DATA BY WEEKS - ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ ŸÉÿ£ÿπŸÖÿØÿ© ŸÖŸÜŸÅÿµŸÑÿ© */
/* ----------------------------------------------------------- */
function groupDataByWeeks(data) {
  const weeks = [
    { name: 'Week 1', range: '1-7', count: 0, hrs: [] },
    { name: 'Week 2', range: '8-14', count: 0, hrs: [] },
    { name: 'Week 3', range: '15-21', count: 0, hrs: [] },
    { name: 'Week 4', range: '22-31', count: 0, hrs: [] }
  ];

  data.forEach(r => {
    const cd = new Date(r["Created Date"]);
    const rd = new Date(r["Response Date"]);
    
    if(!isNaN(cd) && !isNaN(rd)){
      const dayOfMonth = cd.getDate();
      const diff = (rd - cd) / 3600000;
      
      let weekIndex;
      if (dayOfMonth <= 7) {
        weekIndex = 0;
      } else if (dayOfMonth <= 14) {
        weekIndex = 1;
      } else if (dayOfMonth <= 21) {
        weekIndex = 2;
      } else {
        weekIndex = 3;
      }
      
      weeks[weekIndex].count++;
      weeks[weekIndex].hrs.push(diff);
    }
  });

  return weeks;
}

/* ----------------------------------------------------------- */
function loadJSON(){
  const file=document.getElementById("jsonFile").files[0];
  if(!file){alert("ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ JSON");return;}

  let reader=new FileReader();
  reader.onload=e=>{
    rawData=JSON.parse(e.target.result);

    buildFilters(rawData);
    document.getElementById("filtersSection").style.display="grid";
    document.getElementById("kpiRow").style.display="grid";
    document.getElementById("distributionSection").style.display="grid";
    document.getElementById("chartsSection").style.display="block";

    updateDashboard();
  };
  reader.readAsText(file);
}

/* ----------------------------------------------------------- */
/* Build Filters */
function buildFilters(d){
  const months=new Set();
  const regions=new Set();
  const zones=new Set();

  d.forEach(r=>{
    if(r["Created Date"]){
      const dd=new Date(r["Created Date"]);
      if(!isNaN(dd)) {
        const month = `${String(dd.getMonth() + 1).padStart(2, '0')}-${dd.getFullYear()}`;
        months.add(month);
      }
    }
    if(r["Requester Department"]) regions.add(r["Requester Department"]);
    if(r["Zone"]) zones.add(r["Zone"]);
  });

  fillSelect("monthFilter", months, "All Months");
  fillSelect("regionFilter", regions, "All Regions");
  fillSelect("zoneFilter", zones, "All Zones");
}

function fillSelect(id, set, label){
  const s = document.getElementById(id);
  s.innerHTML = `<option value="">${label}</option>`;
  [...set].sort().forEach(v => {
    s.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

/* ----------------------------------------------------------- */
function updateDashboard(){
  const m = document.getElementById("monthFilter").value;
  const r = document.getElementById("regionFilter").value;
  const z = document.getElementById("zoneFilter").value;

  // Filter data based on selections
  let filteredData = rawData.filter(x => {
    let ok = true;
    
    // Month filter
    if (m) {
      const date = new Date(x["Created Date"]);
      if (!isNaN(date)) {
        const itemMonth = `${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
        ok = ok && (itemMonth === m);
      } else {
        ok = false;
      }
    }
    
    // Region filter
    if (r) ok = ok && (x["Requester Department"] === r);
    
    // Zone filter
    if (z) ok = ok && (x["Zone"] === z);
    
    // Category filter
    if (selectedCategory) ok = ok && (x["Category"] === selectedCategory);
    
    return ok;
  });

  // If no data matches the filters, show zeros
  if (filteredData.length === 0 && (m || r || z || selectedCategory)) {
    filteredData = [];
  }

  updateKPIs(filteredData);
  updateDistributions(filteredData);
  drawCharts(filteredData);
}

/* ----------------------------------------------------------- */
function updateKPIs(d){
  document.getElementById("kpiTotal").textContent = d.length;
  document.getElementById("kpiResolved").textContent = d.filter(x => x["Ticket Status"] === "Resolved").length;
  document.getElementById("kpiOpen").textContent = d.filter(x => x["Ticket Status"] !== "Resolved").length;
  document.getElementById("kpiHigh").textContent = d.filter(x => x["Priority"] === "High").length;
}

/* ----------------------------------------------------------- */
function updateDistributions(data){
  // Priority Distribution
  const priorityData = {};
  data.forEach(r => {
    const p = r["Priority"] || "Unknown";
    priorityData[p] = (priorityData[p] || 0) + 1;
  });

  const totalPriority = data.length;
  const priorityContainer = document.getElementById('priorityDistribution');
  priorityContainer.innerHTML = '';

  Object.keys(priorityData).forEach((priority, index) => {
    const count = priorityData[priority];
    const percentage = totalPriority > 0 ? ((count / totalPriority) * 100).toFixed(1) : '0.0';
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑÿ±ŸÇŸÖ
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[index % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${priority}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    priorityContainer.appendChild(item);
  });

  // Status Distribution
  const statusData = {};
  data.forEach(r => {
    const s = r["Ticket Status"] || "Unknown";
    statusData[s] = (statusData[s] || 0) + 1;
  });

  const totalStatus = data.length;
  const statusContainer = document.getElementById('statusDistribution');
  statusContainer.innerHTML = '';

  // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÄ Status ÿ•ŸÑŸâ ÿµŸÅŸäŸÜ (3 ŸÅŸàŸÇ Ÿà3 ÿ™ÿ≠ÿ™)
  const statusEntries = Object.entries(statusData);
  const firstRow = statusEntries.slice(0, 3);
  const secondRow = statusEntries.slice(3, 6);

  // ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ
  firstRow.forEach(([status, count], index) => {
    const percentage = totalStatus > 0 ? ((count / totalStatus) * 100).toFixed(1) : '0.0';
    
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[(index + 3) % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${status}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    statusContainer.appendChild(item);
  });

  // ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä
  secondRow.forEach(([status, count], index) => {
    const percentage = totalStatus > 0 ? ((count / totalStatus) * 100).toFixed(1) : '0.0';
    
    const boxSize = calculateBoxSize(count);
    
    const item = document.createElement('div');
    item.className = 'distribution-item';
    item.innerHTML = `
      <div class="distribution-color" style="
        background: ${glassColors[(index + 6) % glassColors.length]};
        width: ${boxSize.size}px;
        height: ${boxSize.size}px;
        font-size: ${boxSize.fontSize}rem;
      ">
        ${count}
      </div>
      <div class="distribution-name">${status}</div>
      <div class="distribution-percentage">${percentage}%</div>
    `;
    statusContainer.appendChild(item);
  });
}

/* ----------------------------------------------------------- */
/* Draw Charts */
function drawCharts(data){
  const kill = c => c && c.destroy();

  /* TIME CHART ‚Äî Grouped by Weeks */
  const weeksData = groupDataByWeeks(data);
  
  const labels = weeksData.map(week => week.name);
  const count = weeksData.map(week => week.count);
  const avg = weeksData.map(week => {
    const hrs = week.hrs;
    return hrs.length > 0 ? hrs.reduce((a, b) => a + b, 0) / hrs.length : 0;
  });

  let c1 = document.getElementById("chartTime");
  fixCanvasResolution(c1);
  kill(chartTime);

  chartTime = new Chart(c1, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Requests Count",
          data: count,
          backgroundColor: "rgba(10, 132, 255, 0.6)",
          borderColor: "rgba(10, 132, 255, 0.9)",
          borderWidth: 2,
          borderRadius: 8,
          yAxisID: "y"
        },
        {
          label: "Avg Hours",
          type: "line",
          data: avg,
          borderColor: "#ff9500",
          backgroundColor: "rgba(255, 149, 0, 0.1)",
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: "#ff9500",
          pointBorderColor: "#ffffff",
          pointBorderWidth: 2,
          pointHoverRadius: 8,
          tension: 0.35,
          yAxisID: "y1"
        }
      ]
    },
    options: {
      interaction: {
        mode: 'index',
        intersect: false
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Requests Count'
          },
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        y1: {
          position: "right",
          beginAtZero: true,
          title: {
            display: true,
            text: 'Avg Hours'
          },
          grid: {
            drawOnChartArea: false,
          }
        }
      },
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(255,255,255,0.9)',
          titleColor: '#000',
          bodyColor: '#000',
          borderColor: 'rgba(0,0,0,0.1)',
          borderWidth: 1
        },
        legend: {
          labels: {
            color: 'var(--text)'
          }
        }
      }
    }
  });

  /* CATEGORY VERTICAL CARDS with Percentage */
  const catData = {};
  data.forEach(r => {
    const cat = r["Category"] || "Unknown";
    catData[cat] = (catData[cat] || 0) + 1;
  });

  const totalCategories = data.length;
  
  // Sort categories by count
  const sortedCats = Object.entries(catData).sort((a, b) => b[1] - a[1]);
  
  // Create vertical category cards
  const categoryContainer = document.getElementById('categoryContainer');
  categoryContainer.innerHTML = '';
  
  sortedCats.forEach(([category, count], index) => {
    const colorIndex = index % glassColors.length;
    const percentage = totalCategories > 0 ? ((count / totalCategories) * 100).toFixed(1) : '0.0';
    
    const item = document.createElement('div');
    item.className = `category-card ${selectedCategory === category ? 'selected' : ''}`;
    item.style.background = `linear-gradient(135deg, ${glassColors[colorIndex]}, ${glassBorders[colorIndex]})`;
    item.innerHTML = `
      <div class="category-name">${category}</div>
      <div class="category-count">${count}</div>
      <div class="category-percentage">${percentage}%</div>
    `;
    
    // Add click event for category filtering
    item.onclick = function() {
      if (selectedCategory === category) {
        // Deselect if clicking the same category
        selectedCategory = null;
      } else {
        selectedCategory = category;
      }
      updateDashboard();
    };
    
    categoryContainer.appendChild(item);
  });

  /* SUBCATEGORY TREEMAP with Percentage */
  const subData = {};
  data.forEach(r => {
    const sub = r["Sub Category"] || "Unknown";
    subData[sub] = (subData[sub] || 0) + 1;
  });

  const totalSubcategories = data.length;
  
  // Sort subcategories by count
  const sortedSubs = Object.entries(subData).sort((a, b) => b[1] - a[1]);
  
  // Create subcategory treemap
  const subcategoryContainer = document.getElementById('subcategoryContainer');
  subcategoryContainer.innerHTML = '';
  
  sortedSubs.forEach(([subcategory, count], index) => {
    const colorIndex = (index + 2) % glassColors.length;
    const percentage = totalSubcategories > 0 ? ((count / totalSubcategories) * 100).toFixed(1) : '0.0';
    
    const item = document.createElement('div');
    item.className = 'subcategory-item';
    item.style.background = `linear-gradient(135deg, ${glassColors[colorIndex]}, ${glassBorders[colorIndex]})`;
    item.innerHTML = `
      <div class="subcategory-name">${subcategory}</div>
      <div class="subcategory-count">${count}</div>
      <div class="subcategory-percentage">${percentage}%</div>
    `;
    subcategoryContainer.appendChild(item);
  });

  /* TOP SCHOOLS - Horizontal Bar Chart */
  const sch = {};
  data.forEach(r => {
    const name = r["School Name"] || r["Building Name"] || r["School Number"] || "Unknown";
    sch[name] = (sch[name] || 0) + 1;
  });

  const sorted = Object.entries(sch).sort((a, b) => b[1] - a[1]).slice(0, 10);

  let c4 = document.getElementById("chartSchools");
  fixCanvasResolution(c4);
  kill(chartSchools);

  // Prepare colors for schools
  const schoolColors = sorted.map((_, i) => glassColors[i % glassColors.length]);
  const schoolBorders = sorted.map((_, i) => glassBorders[i % glassBorders.length]);

  chartSchools = new Chart(c4, {
    type: "bar",
    data: {
      labels: sorted.map(x => x[0]),
      datasets: [{
        data: sorted.map(x => x[1]),
        backgroundColor: schoolColors,
        borderColor: schoolBorders,
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255,255,255,0.9)',
          titleColor: '#000',
          bodyColor: '#000'
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        }
      }
    }
  });
}
</script>

</body>
</html>